---
import BaseLayout from '../layouts/BaseLayout.astro';

const posts = await Astro.glob('./blog/*.{md,mdx}');
const allPosts = posts
  .filter((post) => post.frontmatter?.pubDate)
  .sort((a, b) => {
    const dateA = new Date(a.frontmatter.pubDate);
    const dateB = new Date(b.frontmatter.pubDate);
    return dateB.getTime() - dateA.getTime();
  });

// Extract slug from file path
const getSlug = (post: any) => {
  const path = post.file;
  const match = path.match(/\/blog\/([^/]+)\.(md|mdx)$/);
  return match ? `/blog/${match[1]}` : post.url;
};

const formatDate = (date: string) => {
  return new Date(date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  });
};
---

<BaseLayout title="Abhinav | Scaling Thoughts" description="ML Engineer at Amazon Special Projects - Foundation Models & Inference">
  <div class="max-w-5xl mx-auto px-6 py-16 sm:py-24">
    <div class="grid lg:grid-cols-[320px_1fr] gap-12 lg:gap-16">
      <!-- Left Column: Profile -->
      <aside>
        <a href="/about" class="block w-32 h-32 mb-6">
          <img
            src="/profile.jpg"
            alt="Abhinav"
            class="w-32 h-32 rounded-full object-cover hover:opacity-80 transition-opacity"
          />
        </a>
        <h1 class="text-2xl font-bold tracking-tight text-ink dark:text-ink-dark mb-1">
          Abhinav
        </h1>
        <p class="text-ink-muted dark:text-ink-dark-muted mb-6">
          Machine Learning Engineer<br />
          <span class="text-accent dark:text-accent-dark">Amazon Special Projects</span>
        </p>

        <p class="text-sm text-ink-muted dark:text-ink-dark-muted leading-relaxed mb-6">
          I build large-scale inference systems for foundation models, focusing on the intersection of Generative AI and Biology. My recent work on cross-model translation and prompt optimization was presented at Amazon ML Conference 2025.
        </p>

        <div class="flex gap-4 text-sm mb-8">
          <a href="https://github.com/abhinavsv3" target="_blank" rel="noopener noreferrer" class="link-subtle">GitHub</a>
          <a href="https://linkedin.com/in/abhinavsv3" target="_blank" rel="noopener noreferrer" class="link-subtle">LinkedIn</a>
          <a href="https://scholar.google.com/citations?user=i_dHJ6cAAAAJ" target="_blank" rel="noopener noreferrer" class="link-subtle">Scholar</a>
        </div>

        <!-- Research Background -->
        <div class="text-sm">
          <h2 class="font-semibold text-ink dark:text-ink-dark mb-3">Background</h2>
          <ul class="space-y-2 text-ink-muted dark:text-ink-dark-muted">
            <li>MS Computer Science, U. of Florida</li>
            <li>Research, UPC Barcelona <a href="https://hdl.handle.net/2117/88495" target="_blank" class="text-accent dark:text-accent-dark hover:underline">[Thesis]</a></li>
            <li>Exchange, Tokyo City University</li>
            <li>Visiting, IMSc Chennai</li>
            <li>B.Tech CS, SASTRA University</li>
          </ul>
        </div>
      </aside>

      <!-- Right Column: Recent Writing -->
      <main>
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xs font-semibold uppercase tracking-widest text-ink-muted dark:text-ink-dark-muted">
            Writing
          </h2>
          <a href="/writing" class="text-xs text-accent dark:text-accent-dark hover:underline">
            View all
          </a>
        </div>

        {allPosts.length > 0 ? (
          <div id="posts-container" class="space-y-4">
            {allPosts.map((post, index) => (
              <a
                href={getSlug(post)}
                class="card group block post-card"
                data-index={index}
                style="display: none;"
              >
                <article>
                  <time
                    datetime={post.frontmatter.pubDate}
                    class="text-xs text-ink-muted dark:text-ink-dark-muted mb-2 block"
                  >
                    {formatDate(post.frontmatter.pubDate)}
                  </time>
                  <h3 class="font-semibold text-ink dark:text-ink-dark group-hover:text-accent dark:group-hover:text-accent-dark transition-colors mb-2">
                    {post.frontmatter.title}
                  </h3>
                  {post.frontmatter.description && (
                    <p class="text-sm text-ink-muted dark:text-ink-dark-muted">
                      {post.frontmatter.description}
                    </p>
                  )}
                </article>
              </a>
            ))}
          </div>
        ) : (
          <p class="text-ink-muted dark:text-ink-dark-muted">
            No posts yet. Check back soon!
          </p>
        )}

        <script>
          // Randomly show 3 posts on each page load
          const cards = document.querySelectorAll('.post-card');
          const indices = Array.from({ length: cards.length }, (_, i) => i);

          // Fisher-Yates shuffle
          for (let i = indices.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [indices[i], indices[j]] = [indices[j], indices[i]];
          }

          // Show first 3 (or all if less than 3)
          const showCount = Math.min(3, indices.length);
          for (let i = 0; i < showCount; i++) {
            const card = document.querySelector(`.post-card[data-index="${indices[i]}"]`);
            if (card) card.style.display = 'block';
          }
        </script>
      </main>
    </div>
  </div>
</BaseLayout>
