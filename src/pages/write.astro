---
import '../styles/global.css';

const today = new Date().toISOString().split('T')[0];
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Write | Scaling Thoughts</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <script is:inline>
      const theme = localStorage.getItem('theme') ??
        (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      if (theme === 'dark') document.documentElement.classList.add('dark');
    </script>
  </head>
  <body class="min-h-screen bg-white dark:bg-gray-950">
    <!-- Top Bar -->
    <header class="fixed top-0 left-0 right-0 z-50 bg-white/80 dark:bg-gray-950/80 backdrop-blur-sm border-b border-gray-200 dark:border-gray-800">
      <div class="max-w-4xl mx-auto px-6 py-3 flex items-center justify-between">
        <a href="/" class="text-sm text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100">
          ‚Üê Back to site
        </a>

        <div class="flex items-center gap-3">
          <span id="slug-display" class="text-sm text-gray-400 dark:text-gray-500 font-mono">
            /blog/untitled
          </span>
          <button
            id="save-btn"
            class="px-4 py-1.5 bg-green-600 text-white text-sm font-medium rounded-full hover:bg-green-700 transition-colors"
          >
            Save
          </button>
          <button
            id="theme-toggle"
            class="p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
          >
            <svg class="w-5 h-5 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
            <svg class="w-5 h-5 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
          </button>
        </div>
      </div>
    </header>

    <!-- Editor -->
    <main class="max-w-3xl mx-auto px-6 pt-24 pb-16">
      <!-- Title -->
      <input
        type="text"
        id="title"
        placeholder="Title"
        class="w-full text-4xl font-bold text-gray-900 dark:text-gray-100 placeholder-gray-300 dark:placeholder-gray-600 bg-transparent border-none outline-none mb-4"
        autofocus
      />

      <!-- Description -->
      <input
        type="text"
        id="description"
        placeholder="Write a brief description..."
        class="w-full text-lg text-gray-500 dark:text-gray-400 placeholder-gray-300 dark:placeholder-gray-600 bg-transparent border-none outline-none mb-8"
      />

      <!-- Tags -->
      <div class="mb-8 flex items-center gap-2">
        <span class="text-sm text-gray-400 dark:text-gray-500">Tags:</span>
        <input
          type="text"
          id="tags"
          placeholder="engineering, systems, ml"
          class="flex-1 text-sm text-gray-600 dark:text-gray-400 placeholder-gray-300 dark:placeholder-gray-600 bg-transparent border-none outline-none"
        />
      </div>

      <!-- Divider -->
      <div class="border-t border-gray-200 dark:border-gray-800 mb-8"></div>

      <!-- Content -->
      <textarea
        id="editor"
        placeholder="Tell your story..."
        class="w-full min-h-[60vh] text-lg text-gray-700 dark:text-gray-300 placeholder-gray-300 dark:placeholder-gray-600 bg-transparent border-none outline-none resize-none leading-relaxed"
      ></textarea>
    </main>

    <!-- Hidden date -->
    <input type="hidden" id="pub-date" value={today} />

    <script>
      const titleInput = document.getElementById('title') as HTMLInputElement;
      const descriptionInput = document.getElementById('description') as HTMLInputElement;
      const tagsInput = document.getElementById('tags') as HTMLInputElement;
      const editor = document.getElementById('editor') as HTMLTextAreaElement;
      const slugDisplay = document.getElementById('slug-display') as HTMLSpanElement;
      const saveBtn = document.getElementById('save-btn') as HTMLButtonElement;
      const themeToggle = document.getElementById('theme-toggle') as HTMLButtonElement;
      const pubDate = (document.getElementById('pub-date') as HTMLInputElement).value;

      // Auto-resize textarea
      function autoResize() {
        editor.style.height = 'auto';
        editor.style.height = Math.max(editor.scrollHeight, 400) + 'px';
      }
      editor.addEventListener('input', autoResize);

      // Update slug from title
      titleInput.addEventListener('input', () => {
        const slug = titleInput.value
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-|-$/g, '') || 'untitled';
        slugDisplay.textContent = `/blog/${slug}`;
      });

      // Theme toggle
      themeToggle.addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
        const isDark = document.documentElement.classList.contains('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
      });

      // Generate markdown
      function generateMarkdown(): string {
        const tags = tagsInput.value
          .split(',')
          .map(t => t.trim())
          .filter(t => t);

        return `---
layout: '../../layouts/PostLayout.astro'
title: '${titleInput.value.replace(/'/g, "''")}'
description: '${descriptionInput.value.replace(/'/g, "''")}'
pubDate: '${pubDate}'
tags: [${tags.map(t => `'${t}'`).join(', ')}]
---

${editor.value}`;
      }

      // Save
      saveBtn.addEventListener('click', async () => {
        if (!titleInput.value.trim()) {
          titleInput.focus();
          return;
        }

        const slug = titleInput.value
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-|-$/g, '') || 'untitled';

        if ('showSaveFilePicker' in window) {
          try {
            const handle = await (window as any).showSaveFilePicker({
              suggestedName: `${slug}.md`,
              types: [{ description: 'Markdown', accept: { 'text/markdown': ['.md'] } }],
            });
            const writable = await handle.createWritable();
            await writable.write(generateMarkdown());
            await writable.close();

            saveBtn.textContent = 'Saved!';
            setTimeout(() => { saveBtn.textContent = 'Save'; }, 2000);
          } catch (err) {
            // User cancelled
          }
        } else {
          // Fallback: download
          const blob = new Blob([generateMarkdown()], { type: 'text/markdown' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${slug}.md`;
          a.click();
          URL.revokeObjectURL(url);
        }
      });

      // Keyboard shortcut: Cmd/Ctrl + S to save
      document.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 's') {
          e.preventDefault();
          saveBtn.click();
        }
      });
    </script>
  </body>
</html>
