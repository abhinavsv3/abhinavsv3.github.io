---
import BaseLayout from '../layouts/BaseLayout.astro';

const posts = await Astro.glob('./blog/*.{md,mdx}');
const sortedPosts = posts.sort(
  (a, b) => new Date(b.frontmatter.pubDate).valueOf() - new Date(a.frontmatter.pubDate).valueOf()
);

// Extract slug from file path
const getSlug = (post: any) => {
  const path = post.file;
  const match = path.match(/\/blog\/([^/]+)\.(md|mdx)$/);
  return match ? `/blog/${match[1]}` : post.url;
};

const formatDate = (date: string) => {
  return new Date(date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  });
};

// Group posts by year
const postsByYear = sortedPosts.reduce((acc, post) => {
  const year = new Date(post.frontmatter.pubDate).getFullYear();
  if (!acc[year]) acc[year] = [];
  acc[year].push(post);
  return acc;
}, {} as Record<number, typeof posts>);

const years = Object.keys(postsByYear).sort((a, b) => Number(b) - Number(a));
---

<BaseLayout title="Writing | Scaling Thoughts" description="All blog posts and articles.">
  <div class="max-w-5xl mx-auto px-6 py-16 sm:py-24">
    <!-- Hero Header -->
    <header class="mb-16">
      <h1 class="text-4xl sm:text-5xl lg:text-hero font-bold tracking-tight text-ink dark:text-ink-dark mb-4">
        Writing
      </h1>
      <p class="text-lg text-ink-muted dark:text-ink-dark-muted">
        Engineering decisions behind production ML systems.
      </p>
    </header>

    {years.length > 0 ? (
      <div class="space-y-16">
        {years.map((year) => (
          <section>
            <h2 class="text-xs font-semibold uppercase tracking-widest text-ink-muted dark:text-ink-dark-muted mb-6">
              {year}
            </h2>
            <div class="grid sm:grid-cols-2 gap-4">
              {postsByYear[Number(year)].map((post) => (
                <a href={getSlug(post)} class="card group block">
                  <article>
                    <time
                      datetime={post.frontmatter.pubDate}
                      class="text-xs text-ink-muted dark:text-ink-dark-muted mb-2 block"
                    >
                      {formatDate(post.frontmatter.pubDate)}
                    </time>
                    <h3 class="font-semibold text-ink dark:text-ink-dark group-hover:text-accent dark:group-hover:text-accent-dark transition-colors mb-2">
                      {post.frontmatter.title}
                    </h3>
                    {post.frontmatter.description && (
                      <p class="text-sm text-ink-muted dark:text-ink-dark-muted line-clamp-2">
                        {post.frontmatter.description}
                      </p>
                    )}
                  </article>
                </a>
              ))}
            </div>
          </section>
        ))}
      </div>
    ) : (
      <p class="text-ink-muted dark:text-ink-dark-muted">
        No posts yet. Check back soon!
      </p>
    )}
  </div>
</BaseLayout>
